name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup & Diagnostics
        uses: appleboy/ssh-action@master
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }} # Needed for context if used later
        with:
          host: 34.225.67.199
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=========================================="
            echo "       DIAGNÃ“STICO DE RECURSOS (INICIO)   "
            echo "=========================================="
            df -h
            free -h
            echo "=========================================="
            
            # --- OPTIMIZACIÃ“N: SWAP (SAFETY NET - 4GB) ---
            # Aumentamos a 4GB para estar 100% seguros con t3.large
            if [ $(swapon --show | wc -l) -eq 0 ]; then
                echo "--- ðŸ’¾ CREANDO SWAP (4GB) ---"
                sudo fallocate -l 4G /swapfile
                sudo chmod 600 /swapfile
                sudo mkswap /swapfile
                sudo swapon /swapfile
                echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
                echo "âœ… Swap activado (4GB)."
            elif [ -f /swapfile ]; then
                 # Si existe pero es pequeÃ±o, podrÃ­amos redimensionarlo,
                 # pero por ahora asumimos que 2GB+ estÃ¡ bien.
                 echo "âœ… Swap ya existe (SAFETY NET ACTIVO)."
                 swapon --show
            fi

      - name: Deploy Main Stack
        uses: appleboy/ssh-action@master
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          INFLUXDB_PASSWORD: ${{ secrets.INFLUXDB_PASSWORD }}
          INFLUXDB_TOKEN: ${{ secrets.INFLUXDB_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_IOT_ENDPOINT: ${{ secrets.AWS_IOT_ENDPOINT }}
        with:
          host: 34.225.67.199
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: POSTGRES_PASSWORD,INFLUXDB_PASSWORD,INFLUXDB_TOKEN,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_IOT_ENDPOINT,LAMBDA_FUNCTION_NAME
          script: |
            # Recuperar variables de entorno para este script
            export POSTGRES_PASSWORD
            export INFLUXDB_PASSWORD
            export INFLUXDB_TOKEN
            export AWS_ACCESS_KEY_ID
            export AWS_SECRET_ACCESS_KEY
            export AWS_IOT_ENDPOINT
            export LAMBDA_FUNCTION_NAME="Aprovisionador-Iot_core"
            
            PROJECT_DIR="saas_synteck"

            if [ ! -d "$PROJECT_DIR" ]; then
              echo "Clonando por primera vez..."
              git clone git@github.com:jose1645/saas_synteck.git
            fi
            
            # --- DIAGNÃ“STICO INICIAL (Visible en logs) ---
            echo "=========================================="
            echo "       DIAGNÃ“STICO DE RECURSOS (INICIO)   "
            echo "=========================================="
            df -h
            free -h
            echo "=========================================="
            
            # --- OPTIMIZACIÃ“N: SWAP (SAFETY NET) ---
            # Incluso con 8GB de RAM, Docker Build puede comerse todo.
            # Restauramos el Swap de 2GB por seguridad.
            if [ $(swapon --show | wc -l) -eq 0 ]; then
                echo "--- ï¿½ CREANDO SWAP (2GB) ---"
                sudo fallocate -l 2G /swapfile
                sudo chmod 600 /swapfile
                sudo mkswap /swapfile
                sudo swapon /swapfile
                echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
                echo "âœ… Swap activado."
            elif [ -f /swapfile ]; then
                 echo "âœ… Swap ya existe (Safety Net activo)."
            fi

            cd "$PROJECT_DIR"
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "--- INICIANDO LIMPIEZA PROFUNDA (Disk Space Fix) ---"
            # 1. Detener servicios
            docker compose down --remove-orphans

            # 2. LIMPIEZA AGRESIVA: Borrar TODAS las imÃ¡genes no usadas, no solo las dangling.
            # Esto es vital para liberar espacio en disco (ENOSPC error)
            docker system prune -a -f
            docker volume prune -f
            
            # ðŸ§¨ IMPORTANTE: Borrar volumen de Postgres para que tome el nuevo password
            # Si no hacemos esto, el error "password authentication failed" persistirÃ¡
            docker volume rm saas_synteck_postgres_data || true

            echo "--- RECONSTRUYENDO SERVICIOS ---"

            echo "--- RECONSTRUYENDO SERVICIOS ---"
            # Construir secuencialmente para no saturar la RAM de la t2.micro
            # Usamos --no-cache (A SOLICITUD DE USUARIO) para garantizar dependencias nuevas
            docker compose build --no-cache api_backend
            docker compose build --no-cache partner_portal
            # Reactivado para instancia Medium
            docker compose build --no-cache client_portal
            docker compose build --no-cache superadmin_portal

            echo "--- LEVANTANDO SISTEMA ---"
            # 4. Levantar todo el stack corregido con la nueva red
            docker compose up -d

            # VerificaciÃ³n rÃ¡pida del estado
            docker ps
            
            echo "--- ESPERANDO ESTABILIZACIÃ“N (15s) ---"
            sleep 15
            
            docker exec saas_api python -m app.seed