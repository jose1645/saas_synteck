name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          INFLUXDB_PASSWORD: ${{ secrets.INFLUXDB_PASSWORD }}
          INFLUXDB_TOKEN: ${{ secrets.INFLUXDB_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_IOT_ENDPOINT: ${{ secrets.AWS_IOT_ENDPOINT }}
        with:
          host: 34.225.67.199
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: POSTGRES_PASSWORD,INFLUXDB_PASSWORD,INFLUXDB_TOKEN,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_IOT_ENDPOINT
          script: |
            echo "--- VERIFICANDO VARIABLES DE ENTORNO REQUIRED ---"
            MISSING_VARS=0
            
            check_var() {
              if [ -z "${!1}" ]; then
                echo "❌ ERROR: La variable de entorno $1 no está definida."
                MISSING_VARS=1
              else
                echo "✅ $1 está presente."
              fi
            }

            check_var "POSTGRES_PASSWORD"
            check_var "INFLUXDB_PASSWORD"
            check_var "INFLUXDB_TOKEN"
            check_var "AWS_ACCESS_KEY_ID"
            check_var "AWS_SECRET_ACCESS_KEY"
            check_var "AWS_IOT_ENDPOINT"

            if [ $MISSING_VARS -ne 0 ]; then
              echo "⛔ DETENIENDO DESPLIEGUE: Faltan variables críticas."
              exit 1
            fi
            
            # Exportar explícitamente para que docker compose las vea
            export POSTGRES_PASSWORD
            export INFLUXDB_PASSWORD
            export INFLUXDB_TOKEN
            export AWS_ACCESS_KEY_ID
            export AWS_SECRET_ACCESS_KEY
            export AWS_IOT_ENDPOINT

            PROJECT_DIR="saas_synteck"

            if [ ! -d "$PROJECT_DIR" ]; then
              echo "Clonando por primera vez..."
              git clone git@github.com:jose1645/saas_synteck.git
            fi

            cd "$PROJECT_DIR"
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            git fetch origin main
            git reset --hard origin/main  # Esto borra cualquier cambio local y fuerza la actualización
            git clean -fd                # Esto borra archivos nuevos que no estén en el repo

            echo "--- INICIANDO LIMPIEZA ---"
            # 1. Detener todos los servicios actuales
            docker compose down --remove-orphans

            # 2. Eliminar contenedores, imágenes y redes que no se estén usando (Limpieza profunda)
            # Esto libera el espacio de las capas de imágenes viejas
            docker system prune -f
            
            # 3. Eliminar volúmenes huérfanos (Opcional: solo si no te importa borrar datos temporales)
            # docker volume prune -f

            echo "--- RECONSTRUYENDO SERVICIOS ---"
            # Construir secuencialmente para no saturar la RAM de la t2.micro
            # Usamos --no-cache para asegurar que todo sea nuevo
            docker compose build --no-cache api_backend
            docker compose build --no-cache partner_portal
            docker compose build --no-cache client_portal
            docker compose build --no-cache superadmin_portal

            echo "--- LEVANTANDO SISTEMA ---"
            # 4. Levantar todo el stack corregido con la nueva red
            docker compose up -d

            # Verificación rápida del estado
            docker ps
            
            # Limpieza final de caché de construcción
            docker builder prune -f
            docker exec saas_api python -m app.seed